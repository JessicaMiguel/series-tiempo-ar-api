sudo: required

services:
  - docker

language: python
python:
  - "2.7"

env:
  - DJANGO_SETTINGS_MODULE=conf.settings.testing

before_install:
 - docker-compose pull
 - docker-compose up -d elasticsearch redis
 - docker-compose ps

install:
  - pip install -r requirements/testing.txt
  - nvm install v7.4.0
  - nvm use v7.4.0
  - npm install

script:
  - npm run jsc
  - scripts/tests.sh
  - scripts/pylint.sh
  - scripts/pycodestyle.sh

after_success:
- coveralls

before_deploy:
 - ssh-keyscan -p $DEPLOY_TARGET_SSH_PORT -t 'rsa,dsa,ecdsa' -H $DEPLOY_TARGET_IP 2>&1 | tee -a $HOME/.ssh/known_hosts
 - openssl aes-256-cbc -K $encrypted_ae74091d1bce_key -iv $encrypted_ae74091d1bce_iv -in deploy/build\+ts-api@travis-ci.org.enc -out /tmp/build\+ts-api@travis-ci.org -d
 - eval "$(ssh-agent -s)"
 - chmod 600 /tmp/build\+ts-api@travis-ci.org
 - ssh-add /tmp/build\+ts-api@travis-ci.org

deploy:
  skip_cleanup: true
  provider: script
  script: scripts/deploy.sh
  on:
    all_branches: true
